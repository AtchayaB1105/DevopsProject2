pipeline {
    agent any

    parameters {
        string(name: 'AWS_REGION', defaultValue: 'us-east-1')
        string(name: 'AWS_ACCOUNT_ID', defaultValue: '123456789000')
        string(name: 'ECR_REPO_NAME', defaultValue: 'amazon-prime-clone')
        string(name: 'VERSION', defaultValue: 'latest')
        string(name: 'CLUSTER_NAME', defaultValue: 'amazon-prime-cluster')
    }

    environment {
        AWS_DEFAULT_REGION = "${params.AWS_REGION}"
        AWS_REGION         = "${params.AWS_REGION}"
    }

    stages {

        stage("Configure AWS & EKS Access") {
            steps {
                withCredentials([
                    string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh """
                    aws sts get-caller-identity

                    aws eks update-kubeconfig \
                      --name ${params.CLUSTER_NAME} \
                      --region ${params.AWS_REGION}

                    kubectl get nodes
                    """
                }
            }
        }

        stage("Configure Prometheus & Grafana") {
            steps {
                withCredentials([
                    string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh """
                    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
                    helm repo update

                    kubectl create namespace prometheus || true

                    helm upgrade --install monitoring \
                      prometheus-community/kube-prometheus-stack \
                      -n prometheus

                    kubectl patch svc monitoring-kube-prometheus-prometheus \
                      -n prometheus -p '{"spec":{"type":"LoadBalancer"}}'

                    kubectl patch svc monitoring-grafana \
                      -n prometheus -p '{"spec":{"type":"LoadBalancer"}}'
                    """
                }
            }
        }

        stage("Configure ArgoCD") {
            steps {
                withCredentials([
                    string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh """
                    kubectl create namespace argocd || true

                    kubectl apply -n argocd \
                      -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

                    kubectl patch svc argocd-server \
                      -n argocd -p '{"spec":{"type":"LoadBalancer"}}'
                    """
                }
            }
        }
    }
}
